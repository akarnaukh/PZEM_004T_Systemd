<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>График данных электроэнергии</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        #fileInput {
            display: none;
        }
        .file-label {
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .file-label:hover {
            background-color: #0b7dda;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
        }
        .current-chart-container {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
        }
        .axis-label {
            font-size: 12px;
            fill: #555;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
            opacity: 0;
            z-index: 10;
        }
        .zoom-controls {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }
        .zoom-btn {
            padding: 5px 10px;
            background-color: #6c757d;
            font-size: 12px;
        }
        .zoom-btn:hover {
            background-color: #5a6268;
        }
        .brush-rect {
            fill: rgba(100, 100, 255, 0.2);
            stroke: #6464ff;
            stroke-width: 1px;
        }
        .status-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>График данных электроэнергии</h1>
        
        <div class="controls">
            <input type="file" id="fileInput" accept=".csv,.log,.txt">
            <label for="fileInput" class="file-label">Выбрать CSV файл</label>
            <button id="loadButton">Загрузить данные</button>
            <div>
                <label>
                    <input type="checkbox" id="voltageCheck" checked> Напряжение
                </label>
                <label>
                    <input type="checkbox" id="currentCheck" checked> Ток
                </label>
                <label>
                    <input type="checkbox" id="frequencyCheck" checked> Частота
                </label>
            </div>
            <div class="zoom-controls">
                <button id="zoomIn" class="zoom-btn">Увеличить</button>
                <button id="zoomOut" class="zoom-btn">Уменьшить</button>
                <button id="resetZoom" class="zoom-btn">Сбросить зум</button>
            </div>
        </div>
        
        <div class="status-info" id="zoomStatus">Масштаб: 100% | Используйте колесо мыши для зума или выделите область</div>
        
        <div class="legend" id="legend"></div>
        
        <div class="chart-title">Напряжение и частота</div>
        <div class="chart-container" id="mainChart"></div>
        
        <div class="chart-title" id="currentChartTitle">Ток</div>
        <div class="current-chart-container" id="currentChart"></div>
    </div>

    <script>
        // Элементы управления
        const fileInput = document.getElementById('fileInput');
        const loadButton = document.getElementById('loadButton');
        const voltageCheck = document.getElementById('voltageCheck');
        const currentCheck = document.getElementById('currentCheck');
        const frequencyCheck = document.getElementById('frequencyCheck');
        const mainChartContainer = document.getElementById('mainChart');
        const currentChartContainer = document.getElementById('currentChart');
        const currentChartTitle = document.getElementById('currentChartTitle');
        const legendContainer = document.getElementById('legend');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const resetZoomBtn = document.getElementById('resetZoom');
        const zoomStatus = document.getElementById('zoomStatus');
        
        // Переменные для данных и графиков
        let data = [];
        let mainSvg, currentSvg;
        let mainXScale, voltageYScale, frequencyYScale, currentYScale;
        let mainXAxis, voltageYAxis, frequencyYAxis, currentYAxis;
        let mainZoomBehavior, currentZoomBehavior;
        
        let margin = { top: 20, right: 80, bottom: 50, left: 60 };
        let mainWidth = mainChartContainer.clientWidth - margin.left - margin.right;
        let mainHeight = mainChartContainer.clientHeight - margin.top - margin.bottom;
        let currentWidth = currentChartContainer.clientWidth - margin.left - margin.right;
        let currentHeight = currentChartContainer.clientHeight - margin.top - margin.bottom;
        
        // Переменные для зума
        let mainZoomTransform = d3.zoomIdentity;
        let currentZoomTransform = d3.zoomIdentity;
        let zoomLevel = 1;
        
        // Цвета для линий
        const colors = {
            voltage: '#e41a1c',
            current: '#377eb8',
            frequency: '#4daf4a'
        };
        
        // Фиксированный диапазон частоты и напряжения
        const frequencyRange = [30, 70]; // Минимальный 10 Гц, максимальный 70 Гц
        const voltageRange = [100, 300]; // Минимальный 100 В, максимальный 300 В
        
        // Обработчик загрузки файла
        loadButton.addEventListener('click', () => {
            if (fileInput.files.length === 0) {
                alert('Пожалуйста, выберите файл');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const csvText = e.target.result;
                parseCSV(csvText);
            };
            
            reader.readAsText(file);
        });
        
        // Парсинг CSV данных
        function parseCSV(csvText) {
            const rows = csvText.split('\n');
            
            data = [];
            
            // Пропускаем заголовок
            for (let i = 1; i < rows.length; i++) {
                if (rows[i].trim() === '') continue;
                
                const values = rows[i].split(',');
                
                if (values.length < 10) continue;
                
                // Парсинг даты и времени
                const timestamp = new Date(values[0] + 'T' + values[1]);
                
                // Проверяем валидность даты
                if (isNaN(timestamp.getTime())) {
                    console.warn('Невалидная дата в строке', i, values[0], values[1]);
                    continue;
                }
                
                data.push({
                    timestamp: timestamp,
                    time: values[1],
                    voltage: parseFloat(values[2]),
                    voltageStatus: values[3],
                    current: parseFloat(values[4]),
                    currentStatus: values[5],
                    frequency: parseFloat(values[6]),
                    frequencyStatus: values[7],
                    power: parseFloat(values[8]),
                    status: parseInt(values[9])
                });
            }
            
            createCharts();
            updateLegend();
        }
        
        // Создание графиков
        function createCharts() {
            // Очистка предыдущих графиков
            d3.select('#mainChart').html('');
            d3.select('#currentChart').html('');
            
            // Создание основного графика (напряжение и частота)
            createMainChart();
            
            // Создание графика тока, если выбран
            if (currentCheck.checked) {
                createCurrentChart();
                currentChartContainer.style.display = 'block';
                currentChartTitle.style.display = 'block';
            } else {
                currentChartContainer.style.display = 'none';
                currentChartTitle.style.display = 'none';
            }
        }
        
        // Создание основного графика (напряжение и частота)
        function createMainChart() {
            // Создание SVG элемента
            mainSvg = d3.select('#mainChart')
                .append('svg')
                .attr('width', mainWidth + margin.left + margin.right)
                .attr('height', mainHeight + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Определение исходных доменов
            const xDomain = d3.extent(data, d => d.timestamp);
            //const frequencyDomain = d3.extent(data, d => d.frequency);
            //const voltageDomain = d3.extent(data, d => d.voltage);
            
            // Используем фиксированный диапазон для частоты и напряжения
            const frequencyDomain = frequencyRange;
            const voltageDomain = voltageRange;
            
            // Определение шкал
            mainXScale = d3.scaleTime()
                .domain(xDomain)
                .range([0, mainWidth]);
            
            voltageYScale = d3.scaleLinear()
                .domain(voltageDomain)
                .range([mainHeight, 0]);
            
            frequencyYScale = d3.scaleLinear()
                .domain(frequencyDomain)
                .range([mainHeight, 0]);
            
            // Сохранение исходных доменов для сброса зума
            mainXScale.originalDomain = xDomain;
            voltageYScale.originalDomain = voltageDomain;
            frequencyYScale.originalDomain = frequencyDomain;
            
            // Создание осей
            mainXAxis = mainSvg.append('g')
                .attr('transform', `translate(0,${mainHeight})`)
                .call(d3.axisBottom(mainXScale)
                    .tickFormat(d3.timeFormat('%H:%M:%S')));
            
            voltageYAxis = mainSvg.append('g')
                .call(d3.axisLeft(voltageYScale));
            
            frequencyYAxis = mainSvg.append('g')
                .attr('transform', `translate(${mainWidth}, 0)`)
                .call(d3.axisRight(frequencyYScale));
            
            // Подписи осей
            mainSvg.append('text')
                .attr('transform', `translate(${mainWidth / 2},${mainHeight + margin.bottom - 10})`)
                .style('text-anchor', 'middle')
                .text('Время');
            
            mainSvg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (mainHeight / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Напряжение (В)');
            
            mainSvg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', mainWidth + margin.right - 10)
                .attr('x', 0 - (mainHeight / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Частота (Гц)');
            
            // Создание линий
            drawMainLines();
            
            // Добавление подсказки
            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip');
            
            // Добавление точек и подсказок
            mainSvg.selectAll('.dot-group')
                .data(data)
                .enter()
                .append('circle')
                .attr('class', 'dot')
                .attr('cx', d => mainXScale(d.timestamp))
                .attr('cy', d => voltageYScale(d.voltage))
                .attr('r', 3)
                .style('fill', 'transparent')
                .on('mouseover', function(event, d) {
                    tooltip
                        .style('opacity', 1)
                        .html(`
                            <div>Время: ${d.time}</div>
                            <div>Напряжение: ${d.voltage} В</div>
                            <div>Ток: ${d.current} А</div>
                            <div>Частота: ${d.frequency} Гц</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });
            
            // Настройка поведения зума
            setupMainZoom();
        }
        
        // Создание графика тока
        function createCurrentChart() {
            // Создание SVG элемента
            currentSvg = d3.select('#currentChart')
                .append('svg')
                .attr('width', currentWidth + margin.left + margin.right)
                .attr('height', currentHeight + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Определение исходных доменов
            const xDomain = d3.extent(data, d => d.timestamp);
            const currentDomain = d3.extent(data, d => d.current);
            
            // Определение шкал
            const currentXScale = d3.scaleTime()
                .domain(xDomain)
                .range([0, currentWidth]);
            
            currentYScale = d3.scaleLinear()
                .domain(currentDomain)
                .range([currentHeight, 0]);
            
            // Создание осей
            currentXAxis = currentSvg.append('g')
                .attr('transform', `translate(0,${currentHeight})`)
                .call(d3.axisBottom(currentXScale)
                    .tickFormat(d3.timeFormat('%H:%M:%S')));
            
            currentYAxis = currentSvg.append('g')
                .call(d3.axisLeft(currentYScale));
            
            // Подписи осей
            currentSvg.append('text')
                .attr('transform', `translate(${currentWidth / 2},${currentHeight + margin.bottom - 10})`)
                .style('text-anchor', 'middle')
                .text('Время');
            
            currentSvg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (currentHeight / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Ток (А)');
            
            // Создание линии тока
            const currentLine = d3.line()
                .x(d => currentXScale(d.timestamp))
                .y(d => currentYScale(d.current));
            
            currentSvg.append('path')
                .datum(data)
                .attr('class', 'line current-line')
                .attr('d', currentLine)
                .style('stroke', colors.current)
                .style('stroke-width', 2)
                .style('fill', 'none');
            
            // Добавление точек и подсказок
            currentSvg.selectAll('.dot-group')
                .data(data)
                .enter()
                .append('circle')
                .attr('class', 'dot')
                .attr('cx', d => currentXScale(d.timestamp))
                .attr('cy', d => currentYScale(d.current))
                .attr('r', 3)
                .style('fill', 'transparent')
                .on('mouseover', function(event, d) {
                    const tooltip = d3.select('.tooltip');
                    tooltip
                        .style('opacity', 1)
                        .html(`
                            <div>Время: ${d.time}</div>
                            <div>Ток: ${d.current} А</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    d3.select('.tooltip').style('opacity', 0);
                });
            
            // Настройка поведения зума для графика тока
            setupCurrentZoom(currentXScale);
        }
        
        // Настройка зума для основного графика
        function setupMainZoom() {
            // Создание поведения зума
            mainZoomBehavior = d3.zoom()
                .scaleExtent([0.5, 20])
                .translateExtent([[0, 0], [mainWidth, mainHeight]])
                .extent([[0, 0], [mainWidth, mainHeight]])
                .on('zoom', mainZoomed);
            
            // Применение зума к SVG
            d3.select('#mainChart svg')
                .call(mainZoomBehavior);
        }
        
        // Настройка зума для графика тока
        function setupCurrentZoom(currentXScale) {
            // Создание поведения зума
            currentZoomBehavior = d3.zoom()
                .scaleExtent([0.5, 20])
                .translateExtent([[0, 0], [currentWidth, currentHeight]])
                .extent([[0, 0], [currentWidth, currentHeight]])
                .on('zoom', currentZoomed);
            
            // Применение зума к SVG
            d3.select('#currentChart svg')
                .call(currentZoomBehavior);
        }
        
        // Обработчик события зума для основного графика
        function mainZoomed(event) {
            mainZoomTransform = event.transform;
            zoomLevel = mainZoomTransform.k;
            
            // Обновление шкал с учетом зума
            const newXScale = mainZoomTransform.rescaleX(mainXScale);
            const newVoltageYScale = mainZoomTransform.rescaleY(voltageYScale);
            
            // Для частоты используем фиксированный домен, но применяем зум к шкале
            const newFrequencyYScale = mainZoomTransform.rescaleY(frequencyYScale);
            
            // Обновление осей
            mainXAxis.call(d3.axisBottom(newXScale).tickFormat(d3.timeFormat('%H:%M:%S')));
            voltageYAxis.call(d3.axisLeft(newVoltageYScale));
            frequencyYAxis.call(d3.axisRight(newFrequencyYScale));
            
            // Обновление линий
            updateMainLines(newXScale, newVoltageYScale, newFrequencyYScale);
            
            // Обновление точек
            mainSvg.selectAll('.dot')
                .attr('cx', d => newXScale(d.timestamp))
                .attr('cy', d => newVoltageYScale(d.voltage));
            
            // Обновление статуса зума
            updateZoomStatus();
        }
        
        // Обработчик события зума для графика тока
        function currentZoomed(event) {
            currentZoomTransform = event.transform;
            
            // Обновление шкал с учетом зума
            const newXScale = currentZoomTransform.rescaleX(d3.scaleTime().domain(d3.extent(data, d => d.timestamp)).range([0, currentWidth]));
            const newYScale = currentZoomTransform.rescaleY(currentYScale);
            
            // Обновление осей
            currentXAxis.call(d3.axisBottom(newXScale).tickFormat(d3.timeFormat('%H:%M:%S')));
            currentYAxis.call(d3.axisLeft(newYScale));
            
            // Обновление линии тока
            const currentLine = d3.line()
                .x(d => newXScale(d.timestamp))
                .y(d => newYScale(d.current));
            
            currentSvg.select('.current-line')
                .attr('d', currentLine);
            
            // Обновление точек
            currentSvg.selectAll('.dot')
                .attr('cx', d => newXScale(d.timestamp))
                .attr('cy', d => newYScale(d.current));
        }
        
        // Отрисовка линий основного графика
        function drawMainLines() {
            // Удаление старых линий
            mainSvg.selectAll('.line').remove();
            
            // Линия напряжения
            if (voltageCheck.checked) {
                const voltageLine = d3.line()
                    .x(d => mainXScale(d.timestamp))
                    .y(d => voltageYScale(d.voltage));
                
                mainSvg.append('path')
                    .datum(data)
                    .attr('class', 'line voltage-line')
                    .attr('d', voltageLine)
                    .style('stroke', colors.voltage)
                    .style('stroke-width', 2)
                    .style('fill', 'none');
            }
            
            // Линия частоты
            if (frequencyCheck.checked) {
                const frequencyLine = d3.line()
                    .x(d => mainXScale(d.timestamp))
                    .y(d => frequencyYScale(d.frequency));
                
                mainSvg.append('path')
                    .datum(data)
                    .attr('class', 'line frequency-line')
                    .attr('d', frequencyLine)
                    .style('stroke', colors.frequency)
                    .style('stroke-width', 2)
                    .style('fill', 'none');
            }
        }
        
        // Обновление линий основного графика при зуме
        function updateMainLines(newXScale, newVoltageYScale, newFrequencyYScale) {
            // Обновление линии напряжения
            if (voltageCheck.checked) {
                const voltageLine = d3.line()
                    .x(d => newXScale(d.timestamp))
                    .y(d => newVoltageYScale(d.voltage));
                
                mainSvg.select('.voltage-line')
                    .attr('d', voltageLine);
            }
            
            // Обновление линии частоты
            if (frequencyCheck.checked) {
                const frequencyLine = d3.line()
                    .x(d => newXScale(d.timestamp))
                    .y(d => newFrequencyYScale(d.frequency));
                
                mainSvg.select('.frequency-line')
                    .attr('d', frequencyLine);
            }
        }
        
        // Обновление статуса зума
        function updateZoomStatus() {
            const zoomPercent = Math.round(zoomLevel * 100);
            zoomStatus.textContent = `Масштаб: ${zoomPercent}% | Используйте колесо мыши для зума или выделите область`;
        }
        
        // Обновление легенды
        function updateLegend() {
            legendContainer.innerHTML = '';
            
            if (voltageCheck.checked) {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${colors.voltage}"></div>
                    <span>Напряжение (В)</span>
                `;
                legendContainer.appendChild(item);
            }
            
            if (currentCheck.checked) {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${colors.current}"></div>
                    <span>Ток (А)</span>
                `;
                legendContainer.appendChild(item);
            }
            
            if (frequencyCheck.checked) {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${colors.frequency}"></div>
                    <span>Частота (Гц)</span>
                `;
                legendContainer.appendChild(item);
            }
        }
        
        // Обработчики изменения состояния чекбоксов
        voltageCheck.addEventListener('change', updateCharts);
        currentCheck.addEventListener('change', updateCharts);
        frequencyCheck.addEventListener('change', updateCharts);
        
        // Обновление графиков при изменении состояния чекбоксов
        function updateCharts() {
            if (data.length > 0) {
                createCharts();
                updateLegend();
            }
        }
        
        // Обработчики кнопок зума
        zoomInBtn.addEventListener('click', () => {
            zoomLevel = Math.min(20, zoomLevel * 1.5);
            applyMainZoom();
        });
        
        zoomOutBtn.addEventListener('click', () => {
            zoomLevel = Math.max(0.5, zoomLevel / 1.5);
            applyMainZoom();
        });
        
        resetZoomBtn.addEventListener('click', () => {
            resetMainZoom();
        });
        
        // Функция применения зума для основного графика
        function applyMainZoom() {
            const centerX = mainWidth / 2;
            const centerY = mainHeight / 2;
            
            // Вычисление нового преобразования
            const newTransform = d3.zoomIdentity
                .translate(centerX, centerY)
                .scale(zoomLevel)
                .translate(-centerX, -centerY);
            
            // Применение преобразования
            d3.select('#mainChart svg')
                .transition()
                .duration(300)
                .call(mainZoomBehavior.transform, newTransform);
        }
        
        // Функция сброса зума для основного графика
        function resetMainZoom() {
            zoomLevel = 1;
            d3.select('#mainChart svg')
                .transition()
                .duration(300)
                .call(mainZoomBehavior.transform, d3.zoomIdentity);
        }
        
        // Обработчик изменения размера окна
        window.addEventListener('resize', function() {
            if (data.length > 0) {
                mainWidth = mainChartContainer.clientWidth - margin.left - margin.right;
                mainHeight = mainChartContainer.clientHeight - margin.top - margin.bottom;
                currentWidth = currentChartContainer.clientWidth - margin.left - margin.right;
                currentHeight = currentChartContainer.clientHeight - margin.top - margin.bottom;
                createCharts();
            }
        });
    </script>
</body>
</html>
